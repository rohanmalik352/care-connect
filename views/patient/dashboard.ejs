<%- include('../partials/head') %>
<%- include('../partials/navbar') %>
<div class="container py-4">
  <%- include('../partials/flash') %>
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold mb-1">Welcome, <%= user.name %></h2>
      <p class="text-muted mb-0">Your health, in one place.</p>
    </div>
    <% if (patient && patient.abhaId) { %>
      <span class="badge bg-teal fs-6 px-3 py-2"><i class="fas fa-id-card me-2"></i>ABHA: <%= patient.abhaId %></span>
    <% } %>
  </div>

  <!-- Quick Stats -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="stat-card card border-0 shadow-sm text-center p-3">
        <div class="stat-icon teal mb-2"><i class="fas fa-file-medical"></i></div>
        <div class="fw-bold fs-4"><%= records.length %></div>
        <div class="text-muted small">Records</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card card border-0 shadow-sm text-center p-3">
        <div class="stat-icon red mb-2"><i class="fas fa-tint"></i></div>
        <div class="fw-bold fs-4"><%= (patient && patient.bloodGroup) || '—' %></div>
        <div class="text-muted small">Blood Group</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card card border-0 shadow-sm text-center p-3">
        <div class="stat-icon blue mb-2"><i class="fas fa-allergies"></i></div>
        <div class="fw-bold fs-4"><%= (patient && patient.allergies) ? patient.allergies.length : 0 %></div>
        <div class="text-muted small">Allergies</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card card border-0 shadow-sm text-center p-3">
        <div class="stat-icon green mb-2"><i class="fas fa-shield-alt"></i></div>
        <div class="fw-bold fs-4">Active</div>
        <div class="text-muted small">Account Status</div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Recent Records -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
          <h5 class="fw-bold mb-0"><i class="fas fa-history me-2 text-teal"></i>Recent Visits</h5>
          <a href="/patient/records" class="btn btn-sm btn-outline-teal">View All</a>
        </div>
        <div class="card-body p-0">
          <% if (records.length === 0) { %>
            <div class="text-center py-5 text-muted">
              <i class="fas fa-file-medical fa-3x mb-3 opacity-25"></i>
              <p>No medical records yet.</p>
            </div>
          <% } else { %>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Date</th><th>Doctor</th><th>Type</th><th>Diagnosis</th><th></th>
                  </tr>
                </thead>
                <tbody>
                  <% records.forEach(r => { %>
                    <tr>
                      <td><%= new Date(r.visitDate).toLocaleDateString('en-IN') %></td>
                      <td><%= r.doctor?.user?.name || 'Unknown' %></td>
                      <td><span class="badge badge-visit-type"><%= r.visitType %></span></td>
                      <td><%= r.diagnosis?.slice(0,2).join(', ') || r.chiefComplaint || '—' %></td>
                      <td><a href="/patient/records/<%= r._id %>" class="btn btn-sm btn-outline-secondary">View</a></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Patient Info Panel -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-header bg-teal text-white py-3">
          <h6 class="mb-0 fw-bold"><i class="fas fa-user me-2"></i>Health Profile</h6>
        </div>
        <div class="card-body">
          <% if (patient) { %>
            <div class="info-row"><span>Blood Group</span><strong><%= patient.bloodGroup || '—' %></strong></div>
            <div class="info-row"><span>Gender</span><strong><%= patient.gender || '—' %></strong></div>
            <div class="info-row"><span>DOB</span><strong><%= patient.dob ? new Date(patient.dob).toLocaleDateString('en-IN') : '—' %></strong></div>
            <% if (patient.allergies && patient.allergies.length > 0) { %>
              <div class="mt-3">
                <small class="text-muted">Allergies</small>
                <div class="mt-1">
                  <% patient.allergies.forEach(a => { %><span class="badge bg-warning text-dark me-1"><%= a %></span><% }) %>
                </div>
              </div>
            <% } %>
            <% if (patient.chronicConditions && patient.chronicConditions.length > 0) { %>
              <div class="mt-3">
                <small class="text-muted">Chronic Conditions</small>
                <div class="mt-1">
                  <% patient.chronicConditions.forEach(c => { %><span class="badge bg-danger me-1"><%= c %></span><% }) %>
                </div>
              </div>
            <% } %>
          <% } else { %>
            <p class="text-muted small mb-2">Complete your health profile for better care.</p>
          <% } %>
          <a href="/patient/profile" class="btn btn-outline-teal btn-sm w-100 mt-3">
            <i class="fas fa-edit me-1"></i>Update Profile
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<%- include('../partials/footer') %>
