<%- include('../partials/head') %>
<%- include('../partials/navbar') %>
<div class="container py-4">
  <%- include('../partials/flash') %>
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <a href="/doctor/search-patient" class="btn btn-outline-secondary btn-sm mb-2"><i class="fas fa-arrow-left me-1"></i>Back</a>
      <h3 class="fw-bold mb-0"><%= patient.user?.name %></h3>
      <p class="text-muted mb-0"><%= patient.user?.email %></p>
    </div>
    <a href="/doctor/add-record/<%= patient._id %>" class="btn btn-teal">
      <i class="fas fa-plus me-2"></i>Add Record
    </a>
  </div>

  <!-- Patient Info -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="info-badge"><i class="fas fa-tint text-danger me-1"></i><%= patient.bloodGroup || '—' %></div>
    </div>
    <div class="col-md-3">
      <div class="info-badge"><i class="fas fa-venus-mars text-teal me-1"></i><%= patient.gender || '—' %></div>
    </div>
    <% if (patient.allergies && patient.allergies.length > 0) { %>
    <div class="col-md-6">
      <div class="info-badge text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Allergies: <%= patient.allergies.join(', ') %></div>
    </div>
    <% } %>
  </div>

  <!-- Records -->
  <h5 class="fw-bold mb-3"><i class="fas fa-history me-2 text-teal"></i>Medical History (<%= records.length %> records)</h5>
  <% if (records.length === 0) { %>
    <div class="text-center py-5 text-muted">
      <i class="fas fa-file-medical fa-4x mb-3 opacity-25"></i>
      <p>No records for this patient yet.</p>
      <a href="/doctor/add-record/<%= patient._id %>" class="btn btn-teal">Add First Record</a>
    </div>
  <% } else { %>
    <div class="row g-3">
      <% records.forEach(r => { %>
        <div class="col-12">
          <div class="card border-0 shadow-sm">
            <div class="card-body d-flex flex-wrap align-items-start gap-3">
              <div class="record-date text-center">
                <div class="fw-bold fs-5"><%= new Date(r.visitDate).getDate() %></div>
                <div class="text-muted small"><%= new Date(r.visitDate).toLocaleString('default', {month:'short'}) %> <%= new Date(r.visitDate).getFullYear() %></div>
              </div>
              <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-2 mb-1">
                  <span class="badge bg-teal"><%= r.visitType %></span>
                  <% if (r.isEmergency) { %><span class="badge bg-danger">Emergency</span><% } %>
                  <small class="text-muted">by Dr. <%= r.doctor?.user?.name || 'Unknown' %></small>
                </div>
                <p class="fw-semibold mb-1"><%= r.chiefComplaint || 'Consultation' %></p>
                <% if (r.diagnosis && r.diagnosis.length > 0) { %>
                  <% r.diagnosis.forEach(d => { %><span class="badge bg-info text-white me-1"><%= d %></span><% }) %>
                <% } %>
                <% if (r.prescription && r.prescription.length > 0) { %>
                  <div class="mt-2">
                    <small class="text-muted"><i class="fas fa-pills me-1"></i><%= r.prescription.map(p => p.medicine).join(', ') %></small>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>
<%- include('../partials/footer') %>
