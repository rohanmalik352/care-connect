<%- include('../partials/head') %>
<%- include('../partials/navbar') %>
<div class="container py-4">
  <a href="/doctor/forum" class="btn btn-outline-secondary btn-sm mb-4"><i class="fas fa-arrow-left me-1"></i>Back to Forum</a>

  <!-- Main Post -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-4">
      <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
        <span class="badge category-badge"><%= discussion.category %></span>
        <% discussion.tags.forEach(t => { %><span class="badge bg-light text-dark border">#<%= t %></span><% }) %>
        <small class="text-muted ms-auto"><i class="fas fa-eye me-1"></i><%= discussion.views %> views</small>
      </div>
      <h3 class="fw-bold mb-3"><%= discussion.title %></h3>
      <div class="discussion-content mb-4" style="white-space:pre-wrap"><%= discussion.content %></div>
      <hr>
      <div class="d-flex align-items-center gap-2 text-muted small">
        <div class="avatar-circle-xs">
          <%= discussion.isAnonymous ? '?' : (discussion.author?.user?.name?.charAt(0).toUpperCase() || 'D') %>
        </div>
        <span>
          Posted by <strong><%= discussion.isAnonymous ? 'Anonymous Doctor' : ('Dr. ' + (discussion.author?.user?.name || 'Unknown')) %></strong>
          &bull; <%= discussion.author?.specialization || '' %>
          &bull; <%= new Date(discussion.createdAt).toLocaleDateString('en-IN', {dateStyle:'long'}) %>
        </span>
      </div>
    </div>
  </div>

  <!-- Replies -->
  <h5 class="fw-bold mb-3"><i class="fas fa-reply me-2 text-teal"></i>Replies (<%= discussion.replies.length %>)</h5>
  <% if (discussion.replies.length === 0) { %>
    <div class="text-center py-4 text-muted mb-4">
      <p>No replies yet. Be the first to respond!</p>
    </div>
  <% } else { %>
    <div class="d-flex flex-column gap-3 mb-4">
      <% discussion.replies.forEach(r => { %>
        <div class="card border-0 shadow-sm">
          <div class="card-body p-3">
            <div class="d-flex gap-3">
              <div class="avatar-circle-xs flex-shrink-0"><%= r.doctor?.user?.name?.charAt(0).toUpperCase() || 'D' %></div>
              <div class="flex-grow-1">
                <div class="fw-semibold small mb-1">Dr. <%= r.doctor?.user?.name || 'Unknown' %></div>
                <div style="white-space:pre-wrap"><%= r.content %></div>
                <div class="text-muted mt-1" style="font-size:0.78rem"><%= new Date(r.createdAt).toLocaleDateString('en-IN') %></div>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>

  <!-- Reply Box -->
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white py-3"><h6 class="fw-bold mb-0">Add Your Reply</h6></div>
    <div class="card-body p-4">
      <form action="/doctor/forum/<%= discussion._id %>/reply" method="POST">
        <textarea name="content" class="form-control mb-3" rows="4" placeholder="Share your expertise or insights..." required></textarea>
        <button type="submit" class="btn btn-teal"><i class="fas fa-paper-plane me-2"></i>Post Reply</button>
      </form>
    </div>
  </div>
</div>
<%- include('../partials/footer') %>
