<%- include('../partials/head') %>
<%- include('../partials/navbar') %>
<div class="dashboard-wrapper">
  <aside class="sidebar">
    <div class="sidebar-logo"><i class="fas fa-heartbeat green me-2"></i>Care<span class="green">Connect</span></div>
    <a href="/doctor/dashboard" class="sidebar-link"><span class="sidebar-icon"><i class="fas fa-th-large"></i></span><span>Dashboard</span></a>
    <a href="/doctor/search-patient" class="sidebar-link"><span class="sidebar-icon"><i class="fas fa-users"></i></span><span>Patient List</span></a>
    <a href="/doctor/forum" class="sidebar-link active"><span class="sidebar-icon"><i class="fas fa-comments"></i></span><span>Collaboration</span></a>
    <a href="/doctor/profile" class="sidebar-link"><span class="sidebar-icon"><i class="fas fa-user-md"></i></span><span>My Profile</span></a>
    <a href="/auth/logout" class="sidebar-link"><span class="sidebar-icon"><i class="fas fa-sign-out-alt"></i></span><span>Logout</span></a>
  </aside>
  <main class="dashboard-content">
    <%- include('../partials/flash') %>
    <div class="dash-topbar">
      <div>
        <h4 class="fw-800 mb-0">Doctor Collaboration Portal</h4>
        <p class="text-muted small mb-0">Connect & share knowledge with doctors globally</p>
      </div>
      <a href="/doctor/forum/new" class="btn btn-green"><i class="fas fa-plus me-2"></i>Start Discussion</a>
    </div>

    <!-- Category filters -->
    <div class="d-flex flex-wrap gap-2 mb-4">
      <a href="/doctor/forum" class="btn btn-sm <%= !category ? 'btn-purple' : 'btn-outline-purple' %> px-3">All</a>
      <% ['Case Discussion','Research','Treatment Protocol','Emergency','General'].forEach(cat => { %>
        <a href="/doctor/forum?category=<%= encodeURIComponent(cat) %>" class="btn btn-sm <%= category === cat ? 'btn-purple' : 'btn-outline-purple' %> px-3"><%= cat %></a>
      <% }) %>
    </div>

    <% if (discussions.length === 0) { %>
      <div class="cc-card p-5 text-center">
        <i class="fas fa-comments fa-4x mb-3" style="color:var(--purple-mid);opacity:0.3"></i>
        <p class="fw-600">No discussions yet</p>
        <a href="/doctor/forum/new" class="btn btn-purple btn-sm">Start the first one</a>
      </div>
    <% } else { %>
      <div class="d-flex flex-column gap-3">
        <% discussions.forEach(d => { %>
          <div class="forum-card">
            <div class="d-flex gap-3">
              <div class="avatar av-<%= ['green','purple','blue'][Math.floor(Math.random()*3)] %>" style="margin-top:2px;flex-shrink:0">
                <%= d.isAnonymous ? '?' : (d.author?.user?.name?.charAt(0).toUpperCase() || 'D') %>
              </div>
              <div class="flex-grow-1">
                <div class="d-flex align-items-center gap-2 mb-1 flex-wrap">
                  <span class="cat-pill cp-<%= {'Case Discussion':'case','Research':'research','Treatment Protocol':'protocol','Emergency':'emergency','General':'general'}[d.category] || 'general' %>"><%= d.category %></span>
                  <% d.tags.slice(0,3).forEach(t => { %><span class="text-muted small">#<%= t %></span><% }) %>
                </div>
                <a href="/doctor/forum/<%= d._id %>" class="text-dark text-decoration-none">
                  <h6 class="fw-700 mb-1"><%= d.title %></h6>
                </a>
                <p class="text-muted small mb-2" style="line-height:1.5"><%= d.content.substring(0,160) %><%= d.content.length > 160 ? '...' : '' %></p>
                <div class="d-flex align-items-center gap-3 flex-wrap">
                  <span class="text-muted small"><i class="fas fa-user-md me-1" style="color:var(--purple)"></i><%= d.isAnonymous ? 'Anonymous' : 'Dr. ' + (d.author?.user?.name || '') %></span>
                  <span class="text-muted small"><i class="fas fa-reply me-1" style="color:var(--green-dark)"></i><%= d.replies.length %> replies</span>
                  <span class="text-muted small"><i class="fas fa-eye me-1"></i><%= d.views %> views</span>
                  <span class="text-muted small"><i class="fas fa-clock me-1"></i><%= new Date(d.createdAt).toLocaleDateString('en-IN') %></span>
                </div>
              </div>
              <a href="/doctor/forum/<%= d._id %>" class="btn btn-outline-purple btn-sm align-self-center d-none d-md-block">View</a>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </main>
</div>
<%- include('../partials/footer') %>
